<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI Business Assistant</title>
  <!-- IBM Plex Sans (Perplexity font) -->
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --color-primary: #2563eb;
      --color-primary-end: #1e40af;
      --color-gradient: linear-gradient(90deg, #2563eb 0%, #1e40af 100%);
      --color-border: #e5e7eb;
      --color-bg: #f9fafb;
      --color-bg-box: #fff;
      --color-secondary: #475569;
      --color-accent: #10b981;
      --color-error: #dc2626;
      --color-edit: #c026d3;
    }

    html, body {
      height: 100%;
      margin: 0;
      background: var(--color-bg);
      font-family: 'IBM Plex Sans', Arial, sans-serif;
      color: var(--color-secondary);
    }
    body {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
    }
    .container {
      background: var(--color-bg-box);
      border: 1px solid var(--color-border);
      border-radius: 18px;
      box-shadow: 0 8px 32px rgba(36,62,99,0.08);
      width: 100%;
      max-width: 700px;
      min-height: 680px;
      margin: 48px auto 0;
      display: flex;
      flex-direction: column;
      position: relative;
    }
    header {
      border-radius: 18px 18px 0 0;
      background: var(--color-gradient);
      color: #fff;
      padding: 0 34px 0 34px;
      min-height: 66px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 8px rgba(36,62,99,0.06);
    }
    .app-title {
      font-weight: 600;
      font-size: 1.3rem;
      letter-spacing: -1px;
      line-height: 1;
    }
    .top-actions {
      display: flex;
      align-items: center;
      gap: 20px;
    }
    #userInfo {
      font-size: 0.98rem;
      font-weight: 500;
      color: #dbeafe;
    }
    .btn, button {
      border: none;
      outline: none;
      cursor: pointer;
      font-family: inherit;
      font-size: 1rem;
      font-weight: 600;
      border-radius: 9px;
      transition: background 0.13s, color 0.13s;
      padding: 10px 20px;
    }
    .btn-primary {
      background: #fff;
      color: var(--color-primary);
      border: 1px solid var(--color-primary-end);
    }
    .btn-primary:hover {
      background: var(--color-primary-end);
      color: #fff;
    }
    .btn-secondary {
      background: #fff;
      color: #dc2626;
      border: 1px solid #dc2626;
    }
    .btn-secondary:hover {
      background: #dc2626;
      color: #fff;
    }

    main {
      flex: 1;
      padding: 20px 34px 18px 34px;
      display: flex;
      flex-direction: column;
      min-height: 540px;
    }

    /* --- Train Agent/Business prompt UI --- */
    .train-row {
      display: flex;
      align-items: center;
      margin: 18px 0 8px 0;
      min-height: 50px;
    }
    .train-btn {
      background: var(--color-gradient);
      color: #fff;
      width: 100%;
      font-size: 1.1rem;
      font-weight: 600;
      border: none;
      border-radius: 11px;
      min-height: 48px;
    }
    .train-btn:hover { filter: brightness(0.95); }
    .train-prompt-view {
      width: 100%;
      background: #f1f5f9;
      border-radius: 11px;
      border: 1.5px solid var(--color-border);
      font-weight: 500;
      font-size: 1.04rem;
      padding: 13px 18px;
      letter-spacing: -0.01em;
      color: var(--color-secondary);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    .train-prompt-edit {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 10px;
      background: #f1f5f9;
      border-radius: 11px;
      border: 1.5px solid var(--color-primary);
      padding: 8px;
    }
    .train-prompt-edit input {
      flex: 1;
      border: none;
      background: transparent;
      font-size: 1rem;
      color: var(--color-secondary);
      padding: 0 8px 0 2px;
      outline: none;
    }
    .train-prompt-edit .save-btn {
      background: var(--color-accent);
      color: #fff;
      min-width: 70px;
    }
    .train-prompt-edit .cancel-btn {
      background: #eee;
      color: #555;
      min-width: 72px;
      border: none;
      font-weight: 500;
    }
    .prompt-edit-btn {
      background: transparent;
      color: var(--color-edit);
      font-size: 1.18rem;
      margin-left: 10px;
      display: flex;
      align-items: center;
      border: none;
      cursor: pointer;
    }
    .prompt-edit-btn:hover { color: #7c3aed; }
    .hidden { display: none !important; }

    /* --- Chat UI --- */
    .chat-box {
      margin: 20px 0 0 0;
      flex: 1;
      background: var(--color-bg-box);
      border-radius: 11px;
      padding: 16px 0;
      border: 1px solid var(--color-border);
      overflow-y: auto;
      min-height: 280px;
      max-height: 390px;
      font-size: 1rem;
    }
    .message {
      margin: 14px 28px;
      padding: 12px 18px;
      border-radius: 13px;
      word-break: break-word;
      line-height: 1.53;
      max-width: 80%;
    }
    .message.user {
      background: var(--color-gradient);
      color: #fff;
      margin-left: auto;
      border-bottom-right-radius: 4px;
    }
    .message.bot {
      background: #f1f5f9;
      color: var(--color-secondary);
      border: 1px solid var(--color-border);
      margin-right: auto;
      border-bottom-left-radius: 4px;
    }
    .input-row {
      display: flex;
      gap: 8px;
      margin: 22px 0 0 0;
    }
    .input-row input {
      flex: 1;
      font-size: 1rem;
      padding: 14px 16px;
      border-radius: 8px;
      border: 1.5px solid var(--color-border);
      outline: none;
      background: #f1f5f9;
    }
    .input-row button {
      background: var(--color-gradient);
      color: #fff;
      border: none;
      padding: 12px 28px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 1.03rem;
    }
    .input-row button:hover { filter: brightness(0.96); }

    /* --- Responsive --- */
    @media (max-width: 600px) {
      .container {
        max-width: 100vw;
        margin: 0;
        min-height: 100vh;
        border-radius: 0;
        border: none;
      }
      main { padding: 18px 6px 18px 6px; }
      .chat-box {
        margin: 8px 0 0 0;
        max-height: 50vw;
        min-height: 110px;
        padding: 7px 0;
      }
      header { border-radius: 0; padding: 0 6px; min-height: 52px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <span class="app-title">AI Business Assistant</span>
      <div class="top-actions">
        <span id="userInfo"></span>
        <button id="googleLoginBtn" class="btn btn-primary hidden">Sign In</button>
        <button id="signOutBtn" class="btn btn-secondary hidden">Sign Out</button>
      </div>
    </header>
    <main>
      <!-- AGENT TRAIN SECTION -->
      <div id="trainRow" class="train-row"></div>
      <!-- CHAT MESSAGES -->
      <div id="chatBox" class="chat-box"></div>
      <!-- USER INPUT -->
      <div class="input-row">
        <input type="text" id="userInput" placeholder="Type a message..." autocomplete="off"/>
        <button id="sendBtn">Send</button>
      </div>
    </main>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDVF5F78NAfjaHky0AIYMkH0lWykAUfKYQ",
  authDomain: "signin-chatbot.firebaseapp.com",
  projectId: "signin-chatbot",
  storageBucket: "signin-chatbot.firebasestorage.app",
  messagingSenderId: "873835781002",
  appId: "1:873835781002:web:4ecee66723e43796128673"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();
const db = getFirestore(app);

let systemPrompt = "";
let trainEditMode = false;

// --- TRAIN PROMPT UI LOGIC ---
function renderTrainPrompt(prompt) {
  const trainRow = document.getElementById('trainRow');
  trainRow.innerHTML = "";

  if (!prompt && !trainEditMode) {
    // Show initial button
    const btn = document.createElement('button');
    btn.className = 'train-btn';
    btn.innerText = 'Train your agent';
    btn.onclick = () => { trainEditMode = true; renderTrainPrompt(""); };
    trainRow.appendChild(btn);
  } else if (trainEditMode) {
    // Edit view: input + Save + Cancel
    const editDiv = document.createElement('div');
    editDiv.className = "train-prompt-edit";
    const input = document.createElement('input');
    input.type = "text";
    input.value = prompt || "";
    input.placeholder = "Describe your agentâ€™s persona, expertise, etc...";
    input.id = "trainPromptInput";
    input.autofocus = true;
    editDiv.appendChild(input);

    // Save
    const saveBtn = document.createElement('button');
    saveBtn.innerText = "Save";
    saveBtn.className = "save-btn";
    saveBtn.onclick = async function() {
      trainEditMode = false;
      let value = input.value.trim();
      if (value) {
        systemPrompt = value;
        await savePrompt(systemPrompt);
      }
      renderTrainPrompt(systemPrompt);
    };
    // Cancel
    const cancelBtn = document.createElement('button');
    cancelBtn.innerText = "Cancel";
    cancelBtn.className = "cancel-btn";
    cancelBtn.onclick = function() {
      trainEditMode = false;
      renderTrainPrompt(systemPrompt);
    };
    editDiv.appendChild(saveBtn);
    editDiv.appendChild(cancelBtn);
    trainRow.appendChild(editDiv);
    setTimeout(() => input.focus(), 80); // Delay for DOM
  } else {
    // Show saved prompt + EDIT
    const viewDiv = document.createElement('div');
    viewDiv.className = "train-prompt-view";
    const promptText = document.createElement('span');
    promptText.innerText = prompt || "";
    viewDiv.appendChild(promptText);

    // Edit button (pencil)
    const editBtn = document.createElement('button');
    editBtn.className = "prompt-edit-btn";
    editBtn.title = "Edit";
    editBtn.innerHTML = `
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" height="22" width="22" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
         d="M15.232 5.232l3.536 3.536m-2.036-1.5A2.5 2.5 0 1116.5 7.5L5 19v3h3L20.5 9.5a2.5 2.5 0 00-3.536-3.536z"/>
      </svg>`;
    editBtn.onclick = () => { trainEditMode = true; renderTrainPrompt(systemPrompt); };
    viewDiv.appendChild(editBtn);

    trainRow.appendChild(viewDiv);
  }
}
async function savePrompt(prompt) {
  const user = auth.currentUser;
  if (user && prompt !== "") {
    try { await setDoc(doc(db, "users", user.uid), { prompt }); }
    catch (error) { alert("Error saving prompt: " + error); }
  }
}

// --- AUTH HANDLING ---
onAuthStateChanged(auth, async (user) => {
  const userInfo = document.getElementById('userInfo');
  const googleLoginBtn = document.getElementById('googleLoginBtn');
  const signOutBtn = document.getElementById('signOutBtn');

  if (user) {
    googleLoginBtn.classList.add('hidden');
    signOutBtn.classList.remove('hidden');
    userInfo.innerHTML = `&#x2705; <strong>${user.displayName || user.email}</strong>`;
    try {
      const docRef = doc(db, "users", user.uid);
      const docSnap = await getDoc(docRef);
      systemPrompt = docSnap.exists() ? docSnap.data().prompt || "" : "";
      renderTrainPrompt(systemPrompt);
    } catch {
      renderTrainPrompt("");
    }
  } else {
    userInfo.innerHTML = "";
    signOutBtn.classList.add('hidden');
    googleLoginBtn.classList.remove('hidden');
    systemPrompt = "";
    renderTrainPrompt("");
  }
});
document.getElementById('googleLoginBtn').addEventListener('click', () => {
  signInWithPopup(auth, provider).catch(error => alert(error.message));
});
document.getElementById('signOutBtn').addEventListener('click', async () => {
  await signOut(auth);
  systemPrompt = "";
  renderTrainPrompt("");
});

// Initial UI (if not logged-in)
renderTrainPrompt("");

// --- CHAT BOT LOGIC ---
document.getElementById('sendBtn').addEventListener('click', sendMessage);
document.getElementById('userInput').addEventListener('keypress', function(e) {
  if (e.key === 'Enter') sendMessage();
});
async function sendMessage() {
  const userInput = document.getElementById('userInput').value;
  if (!userInput) return;
  displayMessage(userInput, 'user');
  document.getElementById('userInput').value = '';
  try {
    const response = await fetch('https://india-therapist-chatbot.onrender.com/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ userMessage: userInput, systemPrompt })
    });
    const data = await response.json();
    displayMessage(data.reply, 'bot');
  } catch {
    displayMessage('Error connecting to chatbot server.', 'bot');
  }
}
function displayMessage(text, sender) {
  const chatBox = document.getElementById('chatBox');
  const msgDiv = document.createElement('div');
  msgDiv.className = `message ${sender}`;
  msgDiv.textContent = text;
  chatBox.appendChild(msgDiv);
  chatBox.scrollTop = chatBox.scrollHeight;
}
</script>
</body>
</html>
